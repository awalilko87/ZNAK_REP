SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
CREATE view [dbo].[OBJTECHPROT_PZOV]
as
select 
 [POT_ROWID],
 [POT_CODE],
 [POT_CODE_COL] = ' <span style="color:'+ case when exists (select 1 from OBJTECHPROTLN where POL_POTID = POT_ROWID and POL_PS_ACCEPT = 0 and POL_STATUS = 'PZL_001')then 'red' else 'black' end+';">'+POT_CODE+'</span><br>',
 [POT_ORG], 
 [POT_DESC], 
 [POT_DESC_COL] = ' <span style="color:'+ case when exists (select 1 from OBJTECHPROTLN where POL_POTID = POT_ROWID and POL_PS_ACCEPT = 0 and POL_STATUS = 'PZL_001')then 'red' else 'black' end+';">'+POT_DESC+'</span><br>',
 [POT_NOTE],
 [POT_DATE],
 [POT_STATUS],
 [POT_STATUS_DESC] = (select STA_DESC from STA (nolock) where STA_CODE = POT_STATUS and STA_ENTITY = 'POT'),
 [POT_TYPE], 
 [POT_TYPE_DESC] = (select TYP_DESC from TYP (nolock) where TYP_CODE = POT_TYPE and TYP_ENTITY = 'POT'),
 [POT_TYPE2],
 [POT_TYPE2_DESC] = (select TYP2.TYP2_DESC from TYP2 (nolock) join TYP (nolock) on TYP.TYP_ROWID = TYP2.TYP2_TYP1ID where TYP2.TYP2_CODE = POT_TYPE2 and TYP_ENTITY = 'POT'),
 [POT_TYPE3],
 [POT_TYPE3_DESC] = (select TYP3.TYP3_DESC from TYP3 (nolock) join TYP2 (nolock) on TYP2.TYP2_ROWID = TYP3.TYP3_TYP2ID join TYP (nolock) on TYP.TYP_ROWID = TYP2.TYP2_TYP1ID where TYP3.TYP3_CODE = POT_TYPE3 and TYP_ENTITY = 'POT'),
 [POT_RSTATUS],
 [POT_CREUSER],
 [POT_CREUSER_DESC] = dbo.UserName(POT_CREUSER),
 [POT_CREDATE],
 [POT_UPDUSER],
 [POT_UPDUSER_DESC] = dbo.UserName(POT_UPDUSER),
 [POT_UPDDATE],
 [POT_NOTUSED],
 [POT_ID],
 [POT_STNID],
 [POT_STN] = [STN_CODE],
 [POT_STN_DESC] = [STN_DESC], 
 [POT_TXT01],
 [POT_TXT02],
 [POT_TXT03],
 [POT_TXT04],
 [POT_TXT05],
 [POT_TXT06],
 [POT_TXT07],
 [POT_TXT08],
 [POT_TXT09],
 [POT_NTX01],
 [POT_NTX02],
 [POT_NTX03],
 [POT_NTX04],
 [POT_NTX05],
 [POT_COM01],
 [POT_COM02],
 [POT_DTX01],
 [POT_DTX02],
 [POT_DTX03],
 [POT_DTX04],
 [POT_DTX05],
 [POT_PSP_POSKI],
 [POT_STNID_VIEW] = [STN_FILTER_ID],
 POT_REALIZATOR,
 POT_REALIZATOR_DESC = dbo.UserName(POT_REALIZATOR),
 POT_MANAGER,
 POT_MANAGER_DESC = dbo.UserName(POT_MANAGER),
 POT_KOMISJA,
 CHK_GU_DZR,
 CHK_GU_DZR_USER,
 CHK_GU_IT,
 CHK_GU_IT_USER,
 CHK_GU_RKB, 
 CHK_GU_RKB_USER,
 CHK_GU_UR,
 CHK_GU_UR_USER 

from [dbo].[OBJTECHPROT] (nolock)
inner join dbo.STATIONv (nolock) on STN_ROWID = [POT_STNID]
where POT_TYPE = 'ZDAWCZY' 
GO